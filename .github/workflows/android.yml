name: Android CI

on:
  push:
    branches: 
      - 'demo**'  # 只在 demo 开头的分支触发，如 demo, demo-sensor, demo-game 等
  pull_request:
    branches:
      - 'demo**'
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Cache Android NDK
      id: cache-ndk
      uses: actions/cache@v4
      with:
        path: ${{ env.ANDROID_SDK_ROOT }}/ndk/26.1.10909125
        key: ndk-26.1.10909125-${{ runner.os }}
        
    - name: Install Android NDK
      if: steps.cache-ndk.outputs.cache-hit != 'true'
      run: |
        echo "y" | sdkmanager --install "ndk;26.1.10909125"
        
    - name: Set NDK environment
      run: |
        export ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/26.1.10909125
        echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
        echo "NDK installed at: $ANDROID_NDK_HOME"
        
    - name: Install Android SDK Build Tools and Platform
      run: |
        echo "y" | sdkmanager --install "build-tools;35.0.0"
        echo "y" | sdkmanager --install "platforms;android-35"
        
    - name: Setup xmake
      uses: xmake-io/github-action-setup-xmake@v1
      with:
        xmake-version: latest
        
    - name: Cache xmake packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.xmake/packages
          .xmake
        key: xmake-android-${{ runner.os }}-${{ hashFiles('**/xmake.lua') }}
        restore-keys: |
          xmake-android-${{ runner.os }}-
        
    - name: Configure xmake for Android
      run: |
        xmake f -p android -a arm64-v8a --ndk=$ANDROID_NDK_HOME -m release -y
        
    - name: Build Android APK
      run: |
        xmake build -v
        
    - name: Install APK to build directory
      run: |
        xmake install -o build
        
    - name: List build output
      run: |
        echo "Build directory contents:"
        ls -lah build/
        find build -name "*.apk" -o -name "*.so"
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: raycpp-android-arm64-v8a
        path: |
          build/*.apk
          build/**/*.apk
        if-no-files-found: error
        retention-days: 30
        
    - name: Upload shared library
      uses: actions/upload-artifact@v4
      with:
        name: raycpp-android-lib-arm64-v8a
        path: |
          build/**/*.so
        if-no-files-found: warn
        retention-days: 30

